import React, { useEffect, useState, useRef } from "react";
import { Link, useNavigate } from "react-router-dom";
import Card from "../components/Card.jsx";
import SkeletonCard from "../components/SkeletonCard.jsx";
import { IconSearch, IconChevronRight, IconCamera, IconBell } from "../components/Icons.jsx";
import SwipeCards from "../components/SwipeCards.jsx";
import { api } from "../api.js";

const SORT_OPTIONS = [
  { value:"newest", label:"Newest" },
  { value:"oldest", label:"Oldest" },
  { value:"price_low", label:"Price: Low" },
  { value:"price_high", label:"Price: High" },
];

const CATEGORIES = [
  { key:"All",         icon:"‚ú®" },
  { key:"Electronics", icon:"üì±" },
  { key:"Clothing",    icon:"üëï" },
  { key:"Furniture",   icon:"ü™ë" },
  { key:"Art",         icon:"üé®" },
  { key:"Books",       icon:"üìö" },
  { key:"Sports",      icon:"‚öΩ" },
  { key:"Toys",        icon:"üéÆ" },
  { key:"Home",        icon:"üè†" },
  { key:"Auto",        icon:"üöó" },
  { key:"Other",       icon:"üì¶" },
];

const SEARCH_PLACEHOLDERS = [
  "Search for electronics near you...",
  "Find deals in your area...",
  "What are you looking for?",
  "List your item in seconds...",
  "Search thousands of local listings...",
];

function money(cents){
  const dollars = cents / 100;
  return dollars % 1 === 0 ? `$${dollars}` : `$${dollars.toFixed(2)}`;
}

function boostTimeLeft(iso){
  if (!iso) return { text:"BOOSTED", bg:"linear-gradient(135deg,var(--cyan),var(--violet))" };
  const diff = (new Date(iso).getTime() - Date.now()) / 1000;
  if (diff <= 0) return { text:"Expired", bg:"#666" };
  const h = Math.floor(diff / 3600);
  const m = Math.floor((diff % 3600) / 60);
  const s = Math.floor(diff % 60);
  const pad = n => String(n).padStart(2, "0");
  const text = diff >= 86400 ? `${Math.floor(diff/86400)}d ${h%24}h` : `${pad(h)}:${pad(m)}:${pad(s)}`;
  const bg = diff > 21600 ? "#27ae60" : diff > 3600 ? "#f39c12" : "#e74c3c";
  return { text, bg };
}

function timeAgo(iso){
  if (!iso) return "";
  const diff = (Date.now() - new Date(iso).getTime()) / 1000;
  if (diff < 60) return "just now";
  if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
  if (diff < 604800) return `${Math.floor(diff/86400)}d ago`;
  return `${Math.floor(diff/604800)}w ago`;
}

const CONDITION_COLORS = {
  "new": { bg:"rgba(46,204,113,.18)", color:"#2ecc71" },
  "like new": { bg:"rgba(62,224,255,.15)", color:"var(--cyan)" },
  "used": { bg:"rgba(255,255,255,.10)", color:"var(--muted)" },
  "fair": { bg:"rgba(243,156,18,.15)", color:"#f39c12" },
};

export default function Home({ me, notify, unreadNotifs = 0 }){
  const [listings, setListings] = useState([]);
  const [featured, setFeatured] = useState([]);
  const [busy, setBusy] = useState(true);
  const [activeCategory, setActiveCategory] = useState("All");
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(false);
  const [loadingMore, setLoadingMore] = useState(false);
  const [swipeMode, setSwipeMode] = useState(false);
  const [sort, setSort] = useState("newest");
  const [, setBoostTick] = useState(0);
  const [placeholder, setPlaceholder] = useState(SEARCH_PLACEHOLDERS[0]);
  const nav = useNavigate();
  const sentinelRef = useRef(null);
  const hasMoreRef = useRef(false);
  const loadingMoreRef = useRef(false);

  // Rotate search placeholder
  useEffect(() => {
    let i = 0;
    const t = setInterval(() => {
      i = (i + 1) % SEARCH_PLACEHOLDERS.length;
      setPlaceholder(SEARCH_PLACEHOLDERS[i]);
    }, 3000);
    return () => clearInterval(t);
  }, []);

  const loadFeed = async (reset = true) => {
    if (reset) setBusy(true);
    else { setLoadingMore(true); loadingMoreRef.current = true; }
    const p = reset ? 1 : page + 1;
    try{
      const [feed, feat] = await Promise.all([
        api.feed(p, sort),
        ...(reset ? [api.featured()] : []),
      ]);
      if (reset) {
        setListings(feed.listings || []);
        setFeatured(feat.featured_listings || []);
      } else {
        setListings(prev => [...prev, ...(feed.listings || [])]);
      }
      setPage(p);
      setHasMore(feed.has_more || false);
      hasMoreRef.current = feed.has_more || false;
    }catch(err){
      notify(err.message);
    }finally{
      setBusy(false);
      setLoadingMore(false);
      loadingMoreRef.current = false;
    }
  };

  const loadMoreRef = useRef(loadFeed);
  loadMoreRef.current = loadFeed;

  useEffect(() => { loadFeed(); }, [sort]);

  useEffect(() => {
    if (!featured.length) return;
    const t = setInterval(() => setBoostTick(n => n + 1), 1000);
    return () => clearInterval(t);
  }, [featured.length]);

  useEffect(() => {
    const el = sentinelRef.current;
    if (!el) return;
    const obs = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting && hasMoreRef.current && !loadingMoreRef.current)
          loadMoreRef.current(false);
      },
      { rootMargin:"200px" }
    );
    obs.observe(el);
    return () => obs.disconnect();
  }, []);

  const filtered = activeCategory === "All"
    ? listings
    : listings.filter(l => (l.category || "").toLowerCase() === activeCategory.toLowerCase());

  const firstName = me?.user?.display_name?.split(" ")[0] || me?.user?.email?.split("@")[0] || "";

  return (
    <>
      {/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */}
      <div style={{ display:"flex", flexDirection:"column", alignItems:"center", padding:"10px 0 4px" }}>
        <img
          src={document.documentElement.getAttribute("data-theme") === "light"
            ? "/pocketmarket_favicon_dark_512x512.png"
            : "/pocketmarket_favicon_transparent_512x512.png"}
          alt="Pocket Market"
          style={{ width:"55%", maxWidth:220, height:"auto" }}
        />
        <div style={{
          fontSize:11, fontWeight:600, color:"var(--muted)",
          letterSpacing:"0.5px", marginTop:2,
        }}>
          Buy Local.&nbsp;&nbsp;Sell Smart.&nbsp;&nbsp;Meet Safe.
        </div>
      </div>

      {/* ‚îÄ‚îÄ Welcome back ‚îÄ‚îÄ */}
      {me?.authed && firstName && (
        <div style={{ textAlign:"center", fontSize:13, color:"var(--muted)", marginBottom:4, marginTop:2 }}>
          Welcome back, <span style={{ color:"var(--cyan)", fontWeight:700 }}>{firstName}</span> üëã
        </div>
      )}

      {/* ‚îÄ‚îÄ Search bar + bell ‚îÄ‚îÄ */}
      <div style={{ display:"flex", gap:10, alignItems:"center", marginTop:6 }}>
        <div
          onClick={() => nav("/search")}
          style={{
            flex:1, minWidth:0, display:"flex", alignItems:"center", gap:10,
            padding:"12px 14px", borderRadius:14,
            background:"var(--panel)", border:"1px solid var(--border)", cursor:"pointer",
          }}
        >
          <IconSearch size={18} color="var(--muted)" />
          <span className="muted" style={{ fontSize:14, overflow:"hidden", whiteSpace:"nowrap", textOverflow:"ellipsis" }}>
            {placeholder}
          </span>
        </div>
        <Link to="/notifications" style={{ position:"relative", display:"flex", flexShrink:0 }}>
          <IconBell size={24} color="var(--muted)" />
          {unreadNotifs > 0 && (
            <div style={{
              position:"absolute", top:-4, right:-4,
              minWidth:16, height:16, borderRadius:8,
              background:"var(--danger)", color:"#fff",
              fontSize:9, fontWeight:800,
              display:"flex", alignItems:"center", justifyContent:"center",
              padding:"0 4px",
            }}>
              {unreadNotifs > 9 ? "9+" : unreadNotifs}
            </div>
          )}
        </Link>
      </div>

      {/* ‚îÄ‚îÄ Category horizontal scroll ‚îÄ‚îÄ */}
      <div style={{
        display:"flex", gap:8, overflowX:"auto", padding:"12px 0 4px",
        scrollbarWidth:"none", msOverflowStyle:"none",
      }}>
        {CATEGORIES.map(({ key, icon }) => (
          <button
            key={key}
            onClick={() => setActiveCategory(activeCategory === key ? "All" : key)}
            style={{
              display:"flex", flexDirection:"column", alignItems:"center", gap:3,
              padding:"9px 12px", borderRadius:14, cursor:"pointer", flexShrink:0,
              border: activeCategory === key ? "1.5px solid var(--cyan)" : "1px solid var(--border)",
              background: activeCategory === key ? "rgba(62,224,255,.14)" : "var(--panel)",
              color: activeCategory === key ? "var(--cyan)" : "var(--text)",
              fontFamily:"inherit", minWidth:56,
              boxShadow: activeCategory === key ? "0 0 14px rgba(62,224,255,.22)" : "none",
              transform: activeCategory === key ? "scale(1.06)" : "scale(1)",
              transition:"all 150ms ease",
            }}
          >
            <span style={{ fontSize:20 }}>{icon}</span>
            <span style={{ fontSize:9, fontWeight:700 }}>{key}</span>
          </button>
        ))}
      </div>
      {/* Hide scrollbar in webkit */}
      <style>{`.cat-scroll::-webkit-scrollbar{display:none}`}</style>

      {/* ‚îÄ‚îÄ Refresh + Swipe mode ‚îÄ‚îÄ */}
      <div style={{ display:"flex", justifyContent:"center", gap:12, padding:"4px 0 2px" }}>
        <button onClick={() => loadFeed(true)} disabled={busy} style={{
          background:"none", border:"none", color:"var(--cyan)",
          fontSize:12, fontWeight:700, cursor:"pointer", padding:"4px 12px",
          fontFamily:"inherit", opacity: busy ? 0.5 : 1,
        }}>
          {busy ? "Loading..." : "‚Üª Refresh"}
        </button>
        {filtered.length > 0 && (
          <div style={{ display:"flex", flexDirection:"column", alignItems:"center", gap:1 }}>
            <button onClick={() => setSwipeMode(true)} style={{
              background:"linear-gradient(135deg,rgba(62,224,255,.12),rgba(164,122,255,.12))",
              border:"1px solid rgba(62,224,255,.28)", borderRadius:16,
              color:"var(--cyan)", fontSize:12, fontWeight:700,
              cursor:"pointer", padding:"5px 14px", fontFamily:"inherit",
            }}>
              üëÜ Swipe Mode
            </button>
            <span style={{ fontSize:9, color:"var(--muted)", letterSpacing:"0.2px" }}>Browse items Tinder-style</span>
          </div>
        )}
      </div>

      {/* ‚îÄ‚îÄ Boosted / Featured ‚îÄ‚îÄ */}
      {featured.length > 0 && (
        <>
          <div className="section-header" style={{ marginTop:8 }}>
            <span className="h2">‚ö° Boosted</span>
            <IconChevronRight size={18} color="var(--muted)" />
          </div>
          <div className="boosted-grid">
            {featured.filter((l, i, arr) => arr.findIndex(x => x.id === l.id) === i).map(l => (
              <Link key={l.id} to={`/listing/${l.id}`}>
                <Card noPadding>
                  <div style={{ position:"relative" }}>
                    {l.images?.length > 0 ? (
                      <img src={`${api.base}${l.images[0]}`} alt={l.title} className="card-image"
                        onError={e => { e.target.onerror=null; e.target.src=""; e.target.className="card-image-placeholder"; }} />
                    ) : (
                      <div className="card-image-placeholder"><IconCamera size={28} /></div>
                    )}
                    {/* gradient overlay */}
                    <div style={{
                      position:"absolute", bottom:0, left:0, right:0, height:"40%",
                      background:"linear-gradient(to top,rgba(0,0,0,.55),transparent)",
                      borderRadius:"0 0 8px 8px", pointerEvents:"none",
                    }}/>
                    {l.is_sold && (
                      <div style={{
                        position:"absolute", top:5, left:5,
                        background:"var(--red,#e74c3c)", color:"#fff",
                        fontSize:8, fontWeight:800, padding:"2px 5px", borderRadius:4,
                      }}>SOLD</div>
                    )}
                    {(() => { const b = boostTimeLeft(l.boost_ends_at); return (
                      <div style={{
                        position:"absolute", top:5, right:5,
                        background:b.bg, color:"#fff",
                        fontSize:7, fontWeight:800, padding:"2px 5px",
                        borderRadius:4, letterSpacing:0.3,
                      }}>{b.text}</div>
                    ); })()}
                  </div>
                  <div style={{ padding:"7px 8px" }}>
                    <div style={{ fontWeight:700, fontSize:11, whiteSpace:"nowrap", overflow:"hidden", textOverflow:"ellipsis" }}>{l.title}</div>
                    <div style={{ marginTop:2, fontSize:12, fontWeight:800, color:"var(--cyan)" }}>{money(l.price_cents)}</div>
                  </div>
                </Card>
              </Link>
            ))}
          </div>
        </>
      )}

      {/* ‚îÄ‚îÄ Nearby Items ‚îÄ‚îÄ */}
      <div className="section-header">
        <span className="h2">{activeCategory === "All" ? "Items Near You" : activeCategory}</span>
        <select value={sort} onChange={e => setSort(e.target.value)} style={{
          background:"var(--input-bg)", border:"1px solid var(--cyan)", borderRadius:8,
          color:"var(--cyan)", fontSize:12, fontWeight:700, padding:"6px 10px",
          fontFamily:"inherit", cursor:"pointer", outline:"none",
        }}>
          {SORT_OPTIONS.map(s => <option key={s.value} value={s.value} style={{ background:"#1a1f2b", color:"#f0f2f5" }}>{s.label}</option>)}
        </select>
      </div>

      <div className="grid">
        {busy ? (
          [...Array(6)].map((_, i) => <SkeletonCard key={i} />)
        ) : filtered.length === 0 ? (
          <Card><div className="muted">{activeCategory === "All" ? "No items yet. Be the first to post!" : `No ${activeCategory.toLowerCase()} items found.`}</div></Card>
        ) : filtered.map(l => (
          <Link key={l.id} to={`/listing/${l.id}`}>
            <Card noPadding>
              <div style={{ position:"relative" }}>
                {l.images?.length > 0 ? (
                  <img src={`${api.base}${l.images[0]}`} alt={l.title} className="card-image"
                    onError={e => { e.target.onerror=null; e.target.src=""; e.target.className="card-image-placeholder"; }} />
                ) : (
                  <div className="card-image-placeholder"><IconCamera size={28} /></div>
                )}
                {/* gradient overlay */}
                <div style={{
                  position:"absolute", bottom:0, left:0, right:0, height:"35%",
                  background:"linear-gradient(to top,rgba(0,0,0,.5),transparent)",
                  pointerEvents:"none",
                }}/>
                {l.is_sold && (
                  <div style={{
                    position:"absolute", top:5, left:5,
                    background:"var(--red,#e74c3c)", color:"#fff",
                    fontSize:9, fontWeight:800, padding:"2px 6px",
                    borderRadius:5, letterSpacing:0.5,
                  }}>SOLD</div>
                )}
                {l.safe_meet && !l.is_sold && (
                  <div style={{
                    position:"absolute", top:5, left:5,
                    background:"rgba(0,0,0,.60)", color:"var(--cyan)",
                    fontSize:8, fontWeight:800, padding:"2px 5px",
                    borderRadius:4,
                  }}>üõ°</div>
                )}
                {l.is_pro_seller && !l.is_sold && (
                  <div style={{
                    position:"absolute", top:5, right:5,
                    background:"linear-gradient(135deg,var(--cyan),var(--violet))", color:"#fff",
                    fontSize:8, fontWeight:800, padding:"2px 5px",
                    borderRadius:4, letterSpacing:0.5,
                  }}>PRO</div>
                )}
              </div>
              <div style={{ padding:"8px 10px" }}>
                <div style={{ fontWeight:700, fontSize:12, whiteSpace:"nowrap", overflow:"hidden", textOverflow:"ellipsis" }}>
                  {l.title}
                </div>
                <div style={{ marginTop:3, display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                  <span style={{ fontWeight:800, fontSize:12, color:"var(--cyan)" }}>{money(l.price_cents)}</span>
                  {l.condition && (() => {
                    const s = CONDITION_COLORS[l.condition.toLowerCase()] || CONDITION_COLORS["used"];
                    return (
                      <span style={{
                        fontSize:8, fontWeight:700, padding:"2px 6px", borderRadius:6,
                        background:s.bg, color:s.color,
                      }}>
                        {l.condition.charAt(0).toUpperCase() + l.condition.slice(1)}
                      </span>
                    );
                  })()}
                </div>
                <div style={{ marginTop:2 }} className="muted">
                  <span style={{ fontSize:9 }}>{timeAgo(l.created_at)}</span>
                </div>
              </div>
            </Card>
          </Link>
        ))}
      </div>

      {/* ‚îÄ‚îÄ Infinite scroll sentinel ‚îÄ‚îÄ */}
      <div ref={sentinelRef} style={{ height:1 }} />
      {loadingMore && (
        <div style={{ display:"flex", justifyContent:"center", padding:"14px 0" }}>
          <span className="muted" style={{ fontSize:13 }}>Loading more...</span>
        </div>
      )}

      {/* ‚îÄ‚îÄ Swipe mode overlay ‚îÄ‚îÄ */}
      {swipeMode && filtered.length > 0 && (
        <SwipeCards
          listings={filtered.filter(l => !l.is_sold)}
          notify={notify}
          onClose={() => setSwipeMode(false)}
        />
      )}
    </>
  );
}
